# .htaccess — caching rules for static assets
# Place in project root (XAMPP Apache). These rules:
# - give long, cacheable lifetimes to static assets (CSS, JS, images, fonts)
# - keep HTML/PHP responses short-lived so updates are picked up quickly

<IfModule mod_expires.c>
  ExpiresActive On
  # Default conservative expiry
  ExpiresDefault "access plus 1 month"

  # HTML should be revalidated frequently
  ExpiresByType text/html "access plus 0 seconds"

  # Long cache for static assets (we version via ?v= so long caching is safe)
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType application/x-javascript "access plus 1 year"
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/* "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
  # Mark versioned static assets as immutable and cacheable
  <FilesMatch "\.(css|js|jpg|jpeg|png|gif|webp|avif|svg|woff2|woff|ttf|eot|otf|ico)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Ensure dynamic pages are not aggressively cached
  <FilesMatch "\.(html|php)$">
    Header set Cache-Control "no-cache, must-revalidate, max-age=0"
  </FilesMatch>
</IfModule>

# End of caching rules############################################
# .htaccess — iMAC Engineering (stable)
# Purpose: keep existing optimisations, fix PSI analysis,
#          normalise trailing slashes, and hide index.php
############################################

# ----------------------------
# 0) Safety / predictable routing
# ----------------------------
# Disable MultiViews to avoid Apache content negotiation guessing
# (prevents /contact-us/ mapping weirdly to index.php or wrong files)
<IfModule mod_negotiation.c>
  Options -MultiViews
</IfModule>

# Ensure index files are used where present
DirectoryIndex index.php index.html

# ----------------------------
# 1) Compression (keep as-is behaviour)
# ----------------------------
<IfModule mod_brotli.c>
  BrotliCompressionQuality 6
  BrotliWindowSize 16
  AddOutputFilterByType BROTLI_COMPRESS \
    text/html text/plain text/css text/javascript application/javascript application/x-javascript \
    application/json application/xml image/svg+xml application/rss+xml application/ld+json \
    font/woff2 font/woff
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE \
    text/html text/plain text/css text/javascript application/javascript application/x-javascript \
    application/json application/xml image/svg+xml application/rss+xml application/ld+json \
    font/woff2 font/woff
  <IfModule mod_headers.c>
    Header append Vary Accept-Encoding
  </IfModule>
</IfModule>

# ----------------------------
# 2) MIME types
# ----------------------------
AddType image/avif avif
AddType image/webp webp

# ----------------------------
# 3) Caching (conservative; matches common best practice)
#    If you already have Expires/Cache-Control elsewhere, you can keep both;
#    Apache will use the most specific rule.
# ----------------------------
<IfModule mod_expires.c>
  ExpiresActive On
  # Static assets (fingerprinted or versioned)
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/jpg  "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff  "access plus 1 year"
  ExpiresByType text/css   "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  # HTML (revalidate)
  ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ----------------------------
# 4) Security headers (minimal; won’t interfere with CSP you set in PHP)
# ----------------------------
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set X-Frame-Options "SAMEORIGIN"
  # You already set: Content-Security-Policy: upgrade-insecure-requests
</IfModule>
# ----------------------------
# 4.1 Conditional revalidation helpers (safe)
# ----------------------------
<IfModule mod_headers.c>
  # Prefer revalidation for HTML responses
  Header merge Cache-Control "public, must-revalidate"

  # Avoid weak/proxy mismatches (we’ll use Last-Modified from PHP)
  Header unset ETag
  FileETag None
</IfModule>

# ----------------------------
# 5) Clean redirects & routing (fix PSI & / vs /)
# ----------------------------
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /

# --- 5.1 Force HTTPS (single hop; safe behind proxies/CDNs) ---
# Redirect only when the request is NOT already HTTPS and NOT coming from a proxy that says it's HTTPS
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# --- 5.2 Canonicalise: remove trailing slash on non-root ---
# Skip real files/dirs first
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
# If URL ends with / AND is not just root
RewriteCond %{REQUEST_URI} .+/$
RewriteRule ^(.+?)/$ /$1 [R=301,L]

# --- 5.3 Hide index.php exposure (canonical to /) ---
RewriteRule ^index\.php$ / [R=301,L]

# --- 5.4 Support extensionless PHP (e.g., /contact-us -> contact-us.php) ---
# Only if a matching .php file exists; internal rewrite, no redirect
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.+)$ $1.php [L]

# --- 5.5 Handle dynamic blog slugs (blog/<slug> → blog-detail.php?BlogUrl=<slug>) ---
RewriteRule ^blog/([a-zA-Z0-9_-]+)$ /blog-detail.php?BlogUrl=$1 [L,QSA]

</IfModule>

# ----------------------------
# 6) Optional: tidy 404 for hidden dotfiles (safety)
# ----------------------------
<FilesMatch "^\.(?!well-known/)">
  Require all denied
</FilesMatch>

############################################
# END — iMAC Engineering .htaccess
############################################
